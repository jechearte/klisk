<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgentKit Chat</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #ffffff;
    --bg-page: #f3f4f6;
    --bg-secondary: #f3f4f6;
    --bg-tertiary: #e5e7eb;
    --text: #1f2937;
    --text-secondary: #6b7280;
    --text-tertiary: #9ca3af;
    --border: #e5e7eb;
    --border-strong: #d1d5db;
    --blue: #2563eb;
    --blue-light: #dbeafe;
    --red-bg: #fef2f2;
    --red-border: #fecaca;
    --red-text: #b91c1c;
    --purple: #7c3aed;
    --code-bg: #f3f4f6;
    --input-bg: #f3f4f6;
    --btn-bg: #111827;
    --btn-text: #ffffff;
    --btn-disabled: #d1d5db;
    --bubble-user: #2563eb;
    --bubble-user-text: #ffffff;
    --bubble-assistant: #f3f4f6;
    --bubble-assistant-text: #1f2937;
    --dot-color: #d1d5db;
  }

  html.dark {
    --bg: #111827;
    --bg-page: #0b0f19;
    --bg-secondary: #1f2937;
    --bg-tertiary: #374151;
    --text: #f3f4f6;
    --text-secondary: #9ca3af;
    --text-tertiary: #6b7280;
    --border: #1f2937;
    --border-strong: #374151;
    --blue: #3b82f6;
    --blue-light: #1e3a5f;
    --red-bg: #3b1111;
    --red-border: #7f1d1d;
    --red-text: #fca5a5;
    --purple: #a78bfa;
    --code-bg: #1f2937;
    --input-bg: #1f2937;
    --btn-bg: #ffffff;
    --btn-text: #111827;
    --btn-disabled: #4b5563;
    --bubble-user: #2563eb;
    --bubble-user-text: #ffffff;
    --bubble-assistant: #1f2937;
    --bubble-assistant-text: #e5e7eb;
    --dot-color: #1e293b;
  }

  html, body {
    height: 100%;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg-page);
    background-image: radial-gradient(circle, var(--dot-color) 1px, transparent 1px);
    background-size: 24px 24px;
    color: var(--text);
  }

  body {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }

  /* Card container */
  .chat-card {
    width: 100%;
    max-width: 720px;
    height: calc(100vh - 48px);
    background: var(--bg);
    border-radius: 16px;
    border: 1px solid var(--border);
    box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Embed mode: card fills entire viewport */
  body.embed {
    padding: 0;
    background: var(--bg);
  }
  body.embed .chat-card {
    max-width: 100%;
    height: 100%;
    border-radius: 0;
    border: none;
    box-shadow: none;
  }
  body.embed .header .theme-btn { display: none; }

  .header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    flex-shrink: 0;
  }
  .header h1 {
    font-size: 15px;
    font-weight: 600;
    flex: 1;
  }
  .header-actions {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .header-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border-strong);
    border-radius: 8px;
    background: none;
    color: var(--text-secondary);
    cursor: pointer;
    transition: color 0.15s, background 0.15s;
  }
  .header-btn:hover {
    color: var(--text);
    background: var(--bg-secondary);
  }
  .header-btn svg { width: 14px; height: 14px; }

  /* Transparent scrollbar */
  .messages::-webkit-scrollbar { width: 6px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 3px; }
  .messages::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }
  .messages { scrollbar-color: var(--border-strong) transparent; scrollbar-width: thin; }

  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .empty-state {
    text-align: center;
    color: var(--text-tertiary);
    margin-top: 80px;
    font-size: 15px;
  }

  .msg, .collapsible { flex-shrink: 0; }
  .msg { display: flex; }
  .msg.user { justify-content: flex-end; }
  .msg.assistant, .msg.error { justify-content: flex-start; }

  .bubble {
    max-width: 85%;
    padding: 8px 14px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.6;
    word-break: break-word;
  }
  .msg.user .bubble {
    background: var(--bubble-user);
    color: var(--bubble-user-text);
    white-space: pre-wrap;
  }
  .msg.assistant .bubble {
    background: var(--bubble-assistant);
    color: var(--bubble-assistant-text);
  }
  .msg.error .bubble {
    background: var(--red-bg);
    color: var(--red-text);
    border: 1px solid var(--red-border);
    white-space: pre-wrap;
  }

  /* Prose styles for assistant markdown */
  .bubble .md > *:first-child { margin-top: 0; }
  .bubble .md > *:last-child { margin-bottom: 0; }
  .bubble .md p { margin: 0.5em 0; }
  .bubble .md strong { font-weight: 600; }
  .bubble .md em { font-style: italic; }
  .bubble .md h1, .bubble .md h2, .bubble .md h3 {
    font-weight: 600;
    margin: 0.8em 0 0.4em;
  }
  .bubble .md h1 { font-size: 1.2em; }
  .bubble .md h2 { font-size: 1.1em; }
  .bubble .md h3 { font-size: 1em; }
  .bubble .md code {
    background: var(--code-bg);
    padding: 1px 5px;
    border-radius: 4px;
    font-size: 0.9em;
    font-family: "SF Mono", Monaco, Consolas, monospace;
  }
  .bubble .md pre {
    background: var(--code-bg);
    padding: 10px 12px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 0.6em 0;
    line-height: 1.45;
  }
  .bubble .md pre code {
    background: none;
    padding: 0;
    font-size: 12px;
  }
  .bubble .md ul, .bubble .md ol {
    margin: 0.5em 0;
    padding-left: 1.5em;
  }
  .bubble .md li { margin: 0.25em 0; }
  .bubble .md li p { margin: 0.2em 0; }
  .bubble .md a {
    color: var(--blue);
    text-decoration: underline;
  }
  .bubble .md blockquote {
    border-left: 3px solid var(--border-strong);
    padding-left: 12px;
    margin: 0.5em 0;
    color: var(--text-secondary);
  }
  .bubble .md hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 0.8em 0;
  }
  .bubble .md table {
    border-collapse: collapse;
    margin: 0.5em 0;
    font-size: 13px;
  }
  .bubble .md th, .bubble .md td {
    border: 1px solid var(--border-strong);
    padding: 4px 8px;
  }
  .bubble .md th {
    background: var(--bg-secondary);
    font-weight: 600;
  }

  /* Collapsible items (tool calls, thinking) */
  .collapsible {
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    max-width: 85%;
  }
  .collapsible-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text-secondary);
    user-select: none;
    background: var(--bg);
  }
  .collapsible-header:hover { background: var(--bg-secondary); }
  .collapsible-header .icon { width: 16px; height: 16px; flex-shrink: 0; }
  .collapsible-header .label { font-weight: 500; }
  .collapsible-header .badge-sm {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 9999px;
    background: var(--bg-tertiary);
    color: var(--text-tertiary);
    margin-left: auto;
  }
  .collapsible-header .badge-sm.running {
    background: var(--blue-light);
    color: var(--blue);
  }
  .collapsible-header .chevron {
    width: 12px;
    height: 12px;
    transition: transform 0.15s;
    color: var(--text-tertiary);
  }
  .collapsible.open .chevron { transform: rotate(90deg); }
  .collapsible-body {
    display: none;
    padding: 8px 12px;
    border-top: 1px solid var(--border);
    font-size: 12px;
  }
  .collapsible.open .collapsible-body { display: block; }
  .collapsible-body pre {
    background: var(--code-bg);
    padding: 6px 8px;
    border-radius: 4px;
    overflow-x: auto;
    white-space: pre-wrap;
    font-size: 11px;
    font-family: "SF Mono", Monaco, Consolas, monospace;
    color: var(--text-secondary);
    max-height: 200px;
    overflow-y: auto;
  }
  .collapsible-body .section-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-tertiary);
    margin-bottom: 4px;
  }
  .collapsible-body .section-label + pre { margin-top: 0; }
  .collapsible-body > div + div { margin-top: 8px; }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .spinning { animation: spin 1s linear infinite; }

  /* Input area */
  .input-area {
    padding: 12px 16px;
    flex-shrink: 0;
  }
  .input-form {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    background: var(--input-bg);
    border: 1px solid var(--border-strong);
    border-radius: 24px;
    padding: 8px 16px;
    transition: border-color 0.15s;
  }
  .input-form:focus-within {
    border-color: var(--text-tertiary);
  }
  .input-form textarea {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    resize: none;
    font-size: 14px;
    line-height: 24px;
    color: var(--text);
    font-family: inherit;
    max-height: 160px;
    padding: 2px 0;
  }
  .input-form textarea::placeholder {
    color: var(--text-tertiary);
  }
  .send-btn {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--btn-bg);
    color: var(--btn-text);
    transition: opacity 0.15s;
  }
  .send-btn:disabled {
    background: var(--btn-disabled);
    color: var(--text-tertiary);
    cursor: default;
  }
  .send-btn svg { width: 16px; height: 16px; }

  /* Auth overlay */
  .auth-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .auth-card {
    background: var(--bg);
    border-radius: 16px;
    border: 1px solid var(--border);
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
    padding: 32px;
    width: 100%;
    max-width: 360px;
    margin: 16px;
  }
  .auth-card h2 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 4px;
  }
  .auth-card p {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 16px;
  }
  .auth-input {
    width: 100%;
    padding: 10px 14px;
    font-size: 14px;
    font-family: inherit;
    border: 1px solid var(--border-strong);
    border-radius: 10px;
    background: var(--input-bg);
    color: var(--text);
    outline: none;
    transition: border-color 0.15s;
  }
  .auth-input:focus { border-color: var(--blue); }
  .auth-submit {
    width: 100%;
    margin-top: 12px;
    padding: 10px;
    font-size: 14px;
    font-weight: 500;
    font-family: inherit;
    border: none;
    border-radius: 10px;
    background: var(--btn-bg);
    color: var(--btn-text);
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .auth-submit:hover { opacity: 0.85; }
  .auth-error-msg {
    font-size: 13px;
    color: var(--red-text);
    margin-top: 8px;
    display: none;
  }

  /* Mobile responsive */
  @media (max-width: 600px) {
    body { padding: 0; }
    .chat-card {
      max-width: 100%;
      height: 100%;
      border-radius: 0;
      border: none;
    }
  }
</style>
</head>
<body>
  <div class="auth-overlay" id="auth-overlay" style="display:none">
    <div class="auth-card">
      <h2>Access Key</h2>
      <p>Enter the access key to start chatting.</p>
      <form id="auth-form">
        <input type="password" class="auth-input" id="auth-input" placeholder="Enter access key" autocomplete="off" />
        <button type="submit" class="auth-submit">Continue</button>
        <div class="auth-error-msg" id="auth-error-msg">Invalid access key. Please try again.</div>
      </form>
    </div>
  </div>

  <div class="chat-card">
    <div class="header" id="header">
      <h1 id="agent-name">AgentKit Chat</h1>
      <div class="header-actions">
        <!-- Theme toggle -->
        <button class="header-btn theme-btn" id="theme-btn" title="Toggle dark mode">
          <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display:none">
            <path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0Zm11.394-5.834a.75.75 0 0 0-1.06-1.06l-1.591 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59Zm-12.728.53a.75.75 0 1 0 1.06-1.06l-1.59-1.591a.75.75 0 0 0-1.061 1.06l1.59 1.591ZM12 18a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-1.5 0v-2.25A.75.75 0 0 1 12 18ZM7.758 17.303a.75.75 0 0 0-1.061-1.06l-1.591 1.59a.75.75 0 0 0 1.06 1.061l1.591-1.59Zm9.544-1.06a.75.75 0 0 0-1.06 1.06l1.59 1.591a.75.75 0 1 0 1.061-1.06l-1.59-1.591ZM21.75 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5H21a.75.75 0 0 1 .75.75ZM5.25 12a.75.75 0 0 1-.75.75H2.25a.75.75 0 0 1 0-1.5H4.5a.75.75 0 0 1 .75.75Z"/>
          </svg>
          <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 6a9 9 0 0 0 9 9 8.97 8.97 0 0 0 3.463-.69.75.75 0 0 1 .981.98 10.503 10.503 0 0 1-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 0 1 .818.162Z" clip-rule="evenodd"/>
          </svg>
        </button>
        <!-- Reset conversation -->
        <button class="header-btn" id="clear-btn" title="Reset conversation">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="messages" id="messages">
      <div class="empty-state" id="empty-state">Send a message to start chatting</div>
    </div>

    <div class="input-area">
      <form class="input-form" id="input-form">
        <textarea id="input" rows="1" placeholder="Type a message..." autocomplete="off"></textarea>
        <button type="submit" class="send-btn" id="send-btn" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
          </svg>
        </button>
      </form>
    </div>
  </div>

<script>
(function() {
  // ---- Theme management ----
  var THEME_KEY = 'agentkit-chat-theme';
  var themeBtn = document.getElementById('theme-btn');
  var iconSun = document.getElementById('theme-icon-sun');
  var iconMoon = document.getElementById('theme-icon-moon');

  function isDark() {
    return document.documentElement.classList.contains('dark');
  }

  function applyTheme(dark) {
    document.documentElement.classList.toggle('dark', dark);
    localStorage.setItem(THEME_KEY, dark ? 'dark' : 'light');
    iconSun.style.display = dark ? 'block' : 'none';
    iconMoon.style.display = dark ? 'none' : 'block';
    themeBtn.title = dark ? 'Switch to light mode' : 'Switch to dark mode';
  }

  // Init theme: saved preference > system preference
  var saved = localStorage.getItem(THEME_KEY);
  if (saved) {
    applyTheme(saved === 'dark');
  } else {
    applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);
  }

  themeBtn.addEventListener('click', function() {
    applyTheme(!isDark());
  });

  // ---- Embed mode & URL params ----
  var params = new URLSearchParams(window.location.search);
  if (params.get('embed') === '1') {
    document.body.classList.add('embed');
  }

  // ---- Auth state ----
  var AUTH_KEY_STORAGE = 'agentkit-chat-key';
  var authRequired = false;
  var authKey = params.get('key') || localStorage.getItem(AUTH_KEY_STORAGE) || '';
  // If key came from URL param (widget embed), persist it
  if (params.get('key')) {
    localStorage.setItem(AUTH_KEY_STORAGE, authKey);
  }

  var authOverlay = document.getElementById('auth-overlay');
  var authForm = document.getElementById('auth-form');
  var authInput = document.getElementById('auth-input');
  var authErrorMsg = document.getElementById('auth-error-msg');

  function showAuthOverlay(errorText) {
    authOverlay.style.display = 'flex';
    authErrorMsg.style.display = errorText ? 'block' : 'none';
    if (errorText) authErrorMsg.textContent = errorText;
    authInput.value = '';
    authInput.focus();
  }

  function hideAuthOverlay() {
    authOverlay.style.display = 'none';
  }

  authForm.addEventListener('submit', function(e) {
    e.preventDefault();
    var val = authInput.value.trim();
    if (!val) return;
    authKey = val;
    localStorage.setItem(AUTH_KEY_STORAGE, authKey);
    hideAuthOverlay();
    connect();
  });

  // ---- DOM refs ----
  var messagesEl = document.getElementById('messages');
  var emptyState = document.getElementById('empty-state');
  var inputEl = document.getElementById('input');
  var sendBtn = document.getElementById('send-btn');
  var form = document.getElementById('input-form');
  var agentNameEl = document.getElementById('agent-name');
  var clearBtn = document.getElementById('clear-btn');

  // ---- Persistence ----
  var MESSAGES_KEY = 'agentkit-chat-messages';
  var RESPONSE_ID_KEY = 'agentkit-chat-response-id';
  var messages = []; // Array of {role, content, tool?, arguments?, output?, status?}
  var responseId = null;

  function saveState() {
    try {
      localStorage.setItem(MESSAGES_KEY, JSON.stringify(messages));
      if (responseId) {
        localStorage.setItem(RESPONSE_ID_KEY, responseId);
      } else {
        localStorage.removeItem(RESPONSE_ID_KEY);
      }
    } catch(e) {}
  }

  function loadState() {
    try {
      var raw = localStorage.getItem(MESSAGES_KEY);
      messages = raw ? JSON.parse(raw) : [];
      responseId = localStorage.getItem(RESPONSE_ID_KEY) || null;
    } catch(e) {
      messages = [];
      responseId = null;
    }
  }

  function clearState() {
    messages = [];
    responseId = null;
    localStorage.removeItem(MESSAGES_KEY);
    localStorage.removeItem(RESPONSE_ID_KEY);
  }

  // Render all messages from the stored array
  function renderAllMessages() {
    // Remove everything except the empty state
    messagesEl.innerHTML = '';
    messagesEl.appendChild(emptyState);

    if (messages.length === 0) {
      emptyState.style.display = '';
      return;
    }
    emptyState.style.display = 'none';

    for (var i = 0; i < messages.length; i++) {
      var m = messages[i];
      if (m.role === 'user' || m.role === 'error') {
        renderBubble(m.role, m.content);
      } else if (m.role === 'assistant') {
        renderBubble('assistant', m.content);
      } else if (m.role === 'thinking') {
        renderCollapsibleEl('thinking', 'Thinking', m.content);
      } else if (m.role === 'tool_call') {
        renderToolCallEl({
          tool: m.tool,
          arguments: m.arguments,
          output: m.output,
          status: m.status || 'done',
        });
      }
    }
    scrollToBottom();
  }

  function renderBubble(role, content) {
    var wrapper = document.createElement('div');
    wrapper.className = 'msg ' + role;
    var bubble = document.createElement('div');
    bubble.className = 'bubble';
    if (role === 'user' || role === 'error') {
      bubble.textContent = content;
    } else {
      var md = document.createElement('div');
      md.className = 'md';
      md.innerHTML = renderMarkdown(content);
      bubble.appendChild(md);
    }
    wrapper.appendChild(bubble);
    messagesEl.appendChild(wrapper);
    return wrapper;
  }

  function renderCollapsibleEl(type, label, content) {
    var el = document.createElement('div');
    el.className = 'collapsible ' + type;
    var iconSvg = type === 'thinking'
      ? '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>'
      : '';
    el.innerHTML =
      '<div class="collapsible-header" onclick="this.parentElement.classList.toggle(\'open\')">' +
        iconSvg +
        '<span class="label">' + escapeHtml(label) + '</span>' +
        '<svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7"/></svg>' +
      '</div>' +
      '<div class="collapsible-body"><pre class="thinking-content">' + escapeHtml(content) + '</pre></div>';
    messagesEl.appendChild(el);
    return el;
  }

  function renderToolCallEl(data) {
    var el = document.createElement('div');
    el.className = 'collapsible tool-call';
    var isDone = data.status !== 'running';
    el.innerHTML =
      '<div class="collapsible-header" onclick="this.parentElement.classList.toggle(\'open\')">' +
        '<svg class="icon' + (isDone ? '' : ' spinning') + '" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">' +
          (isDone
            ? '<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>'
            : '<path d="M21 12a9 9 0 1 1-6.219-8.56"/>') +
        '</svg>' +
        '<span class="label">' + escapeHtml(data.tool || 'tool') + '</span>' +
        '<span class="badge-sm' + (isDone ? '' : ' running') + '">' + (isDone ? 'done' : 'running') + '</span>' +
        '<svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7"/></svg>' +
      '</div>' +
      '<div class="collapsible-body">' +
        (data.arguments ? '<div><div class="section-label">Arguments</div><pre>' + escapeHtml(data.arguments) + '</pre></div>' : '') +
        (data.output ? '<div><div class="section-label">Output</div><pre>' + escapeHtml(data.output) + '</pre></div>' : '') +
      '</div>';
    messagesEl.appendChild(el);
    return el;
  }

  // Fetch agent info and check auth
  fetch('/api/info')
    .then(function(r) { return r.json(); })
    .then(function(info) {
      if (info.name) {
        agentNameEl.textContent = info.name;
        document.title = info.name + ' â€” Chat';
      }
      authRequired = !!info.auth_required;
      if (authRequired && !authKey) {
        showAuthOverlay();
      } else {
        connect();
      }
    })
    .catch(function() {
      // If info fetch fails, try connecting anyway
      connect();
    });

  // ---- Load persisted conversation ----
  loadState();
  renderAllMessages();

  // ---- WebSocket ----
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  var ws = null;
  var reconnectTimer = null;
  var currentAssistantIdx = -1;
  var currentThinkingIdx = -1;

  function connect() {
    if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
    var wsUrl = proto + '//' + location.host + '/ws/chat';
    if (authRequired && authKey) {
      wsUrl += '?key=' + encodeURIComponent(authKey);
    }
    ws = new WebSocket(wsUrl);
    ws.onopen = function() {
      // Restore conversation context on the server
      if (responseId) {
        ws.send(JSON.stringify({ type: 'restore', previous_response_id: responseId }));
      }
    };
    ws.onclose = function() { reconnectTimer = setTimeout(connect, 2000); };
    ws.onerror = function() {};
    ws.onmessage = function(e) {
      handleEvent(JSON.parse(e.data));
    };
  }

  // ---- Clear / reset ----
  clearBtn.addEventListener('click', function() {
    clearState();
    currentAssistantIdx = -1;
    currentThinkingIdx = -1;
    renderAllMessages();
    setSending(false);
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'clear' }));
    }
  });

  // ---- Event handler ----
  function handleEvent(msg) {
    switch (msg.type) {
      case 'token':
        if (currentAssistantIdx < 0) {
          messages.push({ role: 'assistant', content: '' });
          currentAssistantIdx = messages.length - 1;
          emptyState.style.display = 'none';
          renderBubble('assistant', '');
        }
        messages[currentAssistantIdx].content += msg.data;
        // Update the last assistant bubble in DOM
        var assistantEls = messagesEl.querySelectorAll('.msg.assistant');
        var lastA = assistantEls[assistantEls.length - 1];
        if (lastA) lastA.querySelector('.md').innerHTML = renderMarkdown(messages[currentAssistantIdx].content);
        scrollToBottom();
        break;

      case 'thinking':
        if (currentThinkingIdx < 0) {
          messages.push({ role: 'thinking', content: '' });
          currentThinkingIdx = messages.length - 1;
          emptyState.style.display = 'none';
          renderCollapsibleEl('thinking', 'Thinking', '');
        }
        messages[currentThinkingIdx].content += msg.data;
        var thinkEls = messagesEl.querySelectorAll('.collapsible.thinking');
        var lastT = thinkEls[thinkEls.length - 1];
        if (lastT) lastT.querySelector('.thinking-content').textContent = messages[currentThinkingIdx].content;
        scrollToBottom();
        break;

      case 'tool_call':
        currentThinkingIdx = -1;
        messages.push({
          role: 'tool_call',
          tool: msg.data.tool,
          arguments: msg.data.arguments,
          output: '',
          status: 'running',
        });
        emptyState.style.display = 'none';
        renderToolCallEl(msg.data);
        scrollToBottom();
        break;

      case 'tool_result': {
        // Find last tool_call in messages array and update it
        for (var ti = messages.length - 1; ti >= 0; ti--) {
          if (messages[ti].role === 'tool_call' && messages[ti].status === 'running') {
            messages[ti].status = 'done';
            messages[ti].output = msg.data.output || '';
            break;
          }
        }
        // Update DOM
        var toolEls = messagesEl.querySelectorAll('.collapsible.tool-call');
        if (toolEls.length > 0) {
          var last = toolEls[toolEls.length - 1];
          var badge = last.querySelector('.badge-sm');
          if (badge) {
            badge.textContent = 'done';
            badge.classList.remove('running');
          }
          var icon = last.querySelector('.icon');
          if (icon) {
            icon.classList.remove('spinning');
            icon.innerHTML = '<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>';
          }
          if (msg.data.output) {
            var body = last.querySelector('.collapsible-body');
            var div = document.createElement('div');
            div.innerHTML = '<div class="section-label">Output</div><pre>' + escapeHtml(msg.data.output) + '</pre>';
            body.appendChild(div);
          }
        }
        scrollToBottom();
        break;
      }

      case 'done':
        if (msg.response_id) {
          responseId = msg.response_id;
        }
        currentAssistantIdx = -1;
        currentThinkingIdx = -1;
        saveState();
        setSending(false);
        break;

      case 'auth_error':
        // Clear invalid key and stop reconnect loop
        authKey = '';
        localStorage.removeItem(AUTH_KEY_STORAGE);
        if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
        // Override onclose to prevent auto-reconnect for this disconnect
        if (ws) ws.onclose = function() {};
        showAuthOverlay('Invalid access key. Please try again.');
        break;

      case 'error':
        messages.push({ role: 'error', content: msg.data });
        renderBubble('error', msg.data);
        currentAssistantIdx = -1;
        currentThinkingIdx = -1;
        saveState();
        setSending(false);
        scrollToBottom();
        break;
    }
  }

  // ---- Markdown renderer ----
  function renderMarkdown(text) {
    if (!text) return '';

    // Split into code blocks and non-code-block segments
    var parts = [];
    var codeBlockRe = /```(\w*)\n([\s\S]*?)```/g;
    var lastIndex = 0;
    var match;
    while ((match = codeBlockRe.exec(text)) !== null) {
      if (match.index > lastIndex) {
        parts.push({ type: 'text', content: text.slice(lastIndex, match.index) });
      }
      parts.push({ type: 'code', lang: match[1], content: match[2] });
      lastIndex = match.index + match[0].length;
    }
    if (lastIndex < text.length) {
      parts.push({ type: 'text', content: text.slice(lastIndex) });
    }

    var html = '';
    for (var i = 0; i < parts.length; i++) {
      if (parts[i].type === 'code') {
        html += '<pre><code>' + escapeHtml(parts[i].content) + '</code></pre>';
      } else {
        html += renderInlineMarkdown(parts[i].content);
      }
    }
    return html;
  }

  function renderInlineMarkdown(text) {
    // Split by double newline into blocks
    var blocks = text.split(/\n\n+/);
    var html = '';

    for (var i = 0; i < blocks.length; i++) {
      var block = blocks[i].trim();
      if (!block) continue;

      var lines = block.split('\n');

      // Check if entire block is a pure list
      var isUL = lines.every(function(l) { return /^\s*[-*]\s/.test(l) || !l.trim(); });
      var isOL = lines.every(function(l) { return /^\s*\d+\.\s/.test(l) || !l.trim(); });

      if (isUL) {
        html += renderList('ul', lines);
      } else if (isOL) {
        html += renderList('ol', lines);
      } else if (/^#{1,3}\s/.test(block)) {
        var level = block.match(/^(#{1,3})\s/)[1].length;
        var heading = block.replace(/^#{1,3}\s+/, '');
        html += '<h' + level + '>' + inlineFormat(escapeHtml(heading)) + '</h' + level + '>';
      } else if (block.startsWith('>')) {
        var bqText = block.replace(/^>\s?/gm, '');
        html += '<blockquote><p>' + inlineFormat(escapeHtml(bqText)) + '</p></blockquote>';
      } else if (block === '---' || block === '***') {
        html += '<hr>';
      } else {
        // Mixed block: split into runs of text vs list items
        html += renderMixedBlock(lines);
      }
    }
    return html;
  }

  function renderMixedBlock(lines) {
    var html = '';
    var textBuf = [];
    var listBuf = [];
    var listType = null; // 'ul' or 'ol'

    function flushText() {
      if (textBuf.length) {
        var joined = textBuf.map(function(l) { return inlineFormat(escapeHtml(l)); }).join('<br>');
        html += '<p>' + joined + '</p>';
        textBuf = [];
      }
    }
    function flushList() {
      if (listBuf.length && listType) {
        html += renderList(listType, listBuf);
        listBuf = [];
        listType = null;
      }
    }

    for (var i = 0; i < lines.length; i++) {
      var line = lines[i];
      var isULLine = /^\s*[-*]\s/.test(line);
      var isOLLine = /^\s*\d+\.\s/.test(line);

      if (isULLine) {
        if (listType && listType !== 'ul') flushList();
        flushText();
        listType = 'ul';
        listBuf.push(line);
      } else if (isOLLine) {
        if (listType && listType !== 'ol') flushList();
        flushText();
        listType = 'ol';
        listBuf.push(line);
      } else {
        flushList();
        textBuf.push(line);
      }
    }
    flushText();
    flushList();
    return html;
  }

  function renderList(tag, lines) {
    var html = '<' + tag + '>';
    var re = tag === 'ul' ? /^\s*[-*]\s+/ : /^\s*\d+\.\s+/;
    for (var j = 0; j < lines.length; j++) {
      var li = lines[j].replace(re, '');
      if (li.trim()) html += '<li>' + inlineFormat(escapeHtml(li)) + '</li>';
    }
    html += '</' + tag + '>';
    return html;
  }

  function inlineFormat(escaped) {
    // Inline code
    escaped = escaped.replace(/`([^`]+)`/g, '<code>$1</code>');
    // Bold
    escaped = escaped.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    // Italic
    escaped = escaped.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    // Links
    escaped = escaped.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
    return escaped;
  }

  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function scrollToBottom() {
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // ---- Input handling ----
  var sending = false;

  inputEl.addEventListener('input', function() {
    sendBtn.disabled = !inputEl.value.trim() || sending;
    autoResize();
  });

  inputEl.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (inputEl.value.trim() && !sending) {
        submitMessage();
      }
    }
  });

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    if (inputEl.value.trim() && !sending) {
      submitMessage();
    }
  });

  function submitMessage() {
    var text = inputEl.value.trim();
    if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
    messages.push({ role: 'user', content: text });
    saveState();
    emptyState.style.display = 'none';
    renderBubble('user', text);
    scrollToBottom();
    ws.send(JSON.stringify({ message: text }));
    inputEl.value = '';
    autoResize();
    setSending(true);
  }

  function setSending(val) {
    sending = val;
    sendBtn.disabled = val || !inputEl.value.trim();
    inputEl.disabled = val;
    if (!val) inputEl.focus();
  }

  function autoResize() {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + 'px';
  }
})();
</script>
</body>
</html>
