<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgentKit Chat</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #ffffff;
    --bg-secondary: #f3f4f6;
    --bg-tertiary: #e5e7eb;
    --text: #1f2937;
    --text-secondary: #6b7280;
    --text-tertiary: #9ca3af;
    --border: #d1d5db;
    --blue: #2563eb;
    --blue-light: #dbeafe;
    --red-bg: #fef2f2;
    --red-border: #fecaca;
    --red-text: #b91c1c;
    --purple: #7c3aed;
    --code-bg: #f3f4f6;
    --input-bg: #f3f4f6;
    --btn-bg: #111827;
    --btn-text: #ffffff;
    --btn-disabled: #d1d5db;
    --bubble-user: #2563eb;
    --bubble-user-text: #ffffff;
    --bubble-assistant: #f3f4f6;
    --bubble-assistant-text: #1f2937;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #111827;
      --bg-secondary: #1f2937;
      --bg-tertiary: #374151;
      --text: #f3f4f6;
      --text-secondary: #9ca3af;
      --text-tertiary: #6b7280;
      --border: #374151;
      --blue: #3b82f6;
      --blue-light: #1e3a5f;
      --red-bg: #3b1111;
      --red-border: #7f1d1d;
      --red-text: #fca5a5;
      --purple: #a78bfa;
      --code-bg: #1f2937;
      --input-bg: #1f2937;
      --btn-bg: #ffffff;
      --btn-text: #111827;
      --btn-disabled: #4b5563;
      --bubble-user: #2563eb;
      --bubble-user-text: #ffffff;
      --bubble-assistant: #1f2937;
      --bubble-assistant-text: #e5e7eb;
    }
  }

  html, body {
    height: 100%;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  body { display: flex; flex-direction: column; }

  .header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }
  .header h1 {
    font-size: 16px;
    font-weight: 600;
  }
  .header .badge {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 9999px;
    background: var(--bg-secondary);
    color: var(--text-secondary);
  }
  body.embed .header { display: none; }

  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .empty-state {
    text-align: center;
    color: var(--text-tertiary);
    margin-top: 80px;
    font-size: 16px;
  }

  .msg { display: flex; }
  .msg.user { justify-content: flex-end; }
  .msg.assistant, .msg.error { justify-content: flex-start; }

  .bubble {
    max-width: 80%;
    padding: 8px 16px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .msg.user .bubble {
    background: var(--bubble-user);
    color: var(--bubble-user-text);
  }
  .msg.assistant .bubble {
    background: var(--bubble-assistant);
    color: var(--bubble-assistant-text);
  }
  .msg.error .bubble {
    background: var(--red-bg);
    color: var(--red-text);
    border: 1px solid var(--red-border);
  }

  /* Markdown rendering inside assistant bubbles */
  .bubble p { margin: 0.4em 0; }
  .bubble p:first-child { margin-top: 0; }
  .bubble p:last-child { margin-bottom: 0; }
  .bubble strong { font-weight: 600; }
  .bubble em { font-style: italic; }
  .bubble code {
    background: var(--code-bg);
    padding: 1px 4px;
    border-radius: 4px;
    font-size: 13px;
    font-family: "SF Mono", Monaco, Consolas, monospace;
  }
  .bubble pre {
    background: var(--code-bg);
    padding: 8px 12px;
    border-radius: 6px;
    overflow-x: auto;
    margin: 0.5em 0;
  }
  .bubble pre code {
    background: none;
    padding: 0;
    font-size: 12px;
  }
  .bubble ul, .bubble ol {
    margin: 0.4em 0;
    padding-left: 1.5em;
  }
  .bubble li { margin: 0.2em 0; }
  .bubble a {
    color: var(--blue);
    text-decoration: underline;
  }

  /* Collapsible items (tool calls, thinking) */
  .collapsible {
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    max-width: 80%;
  }
  .collapsible-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text-secondary);
    user-select: none;
    background: var(--bg);
  }
  .collapsible-header:hover { background: var(--bg-secondary); }
  .collapsible-header .icon { width: 16px; height: 16px; flex-shrink: 0; }
  .collapsible-header .label { font-weight: 500; }
  .collapsible-header .badge-sm {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 9999px;
    background: var(--bg-tertiary);
    color: var(--text-tertiary);
    margin-left: auto;
  }
  .collapsible-header .badge-sm.running {
    background: var(--blue-light);
    color: var(--blue);
  }
  .collapsible-header .chevron {
    width: 12px;
    height: 12px;
    transition: transform 0.15s;
    color: var(--text-tertiary);
  }
  .collapsible.open .chevron { transform: rotate(90deg); }
  .collapsible-body {
    display: none;
    padding: 8px 12px;
    border-top: 1px solid var(--border);
    font-size: 12px;
  }
  .collapsible.open .collapsible-body { display: block; }
  .collapsible-body pre {
    background: var(--code-bg);
    padding: 6px 8px;
    border-radius: 4px;
    overflow-x: auto;
    white-space: pre-wrap;
    font-size: 11px;
    font-family: "SF Mono", Monaco, Consolas, monospace;
    color: var(--text-secondary);
    max-height: 200px;
    overflow-y: auto;
  }
  .collapsible-body .section-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-tertiary);
    margin-bottom: 4px;
  }
  .collapsible-body .section-label + pre { margin-top: 0; }
  .collapsible-body > div + div { margin-top: 8px; }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .spinning { animation: spin 1s linear infinite; }

  /* Input area */
  .input-area {
    padding: 16px;
    flex-shrink: 0;
  }
  .input-form {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    background: var(--input-bg);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 8px 16px;
    transition: border-color 0.15s;
  }
  .input-form:focus-within {
    border-color: var(--text-tertiary);
  }
  .input-form textarea {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    resize: none;
    font-size: 14px;
    line-height: 24px;
    color: var(--text);
    font-family: inherit;
    max-height: 160px;
    padding: 2px 0;
  }
  .input-form textarea::placeholder {
    color: var(--text-tertiary);
  }
  .send-btn {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--btn-bg);
    color: var(--btn-text);
    transition: opacity 0.15s;
  }
  .send-btn:disabled {
    background: var(--btn-disabled);
    color: var(--text-tertiary);
    cursor: default;
  }
  .send-btn svg { width: 16px; height: 16px; }
</style>
</head>
<body>
  <div class="header" id="header">
    <h1 id="agent-name">AgentKit Chat</h1>
  </div>

  <div class="messages" id="messages">
    <div class="empty-state" id="empty-state">Send a message to start chatting</div>
  </div>

  <div class="input-area">
    <form class="input-form" id="input-form">
      <textarea id="input" rows="1" placeholder="Type a message..." autocomplete="off"></textarea>
      <button type="submit" class="send-btn" id="send-btn" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
        </svg>
      </button>
    </form>
  </div>

<script>
(function() {
  // Embed mode
  const params = new URLSearchParams(window.location.search);
  if (params.get('embed') === '1') {
    document.body.classList.add('embed');
  }

  const messagesEl = document.getElementById('messages');
  const emptyState = document.getElementById('empty-state');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('send-btn');
  const form = document.getElementById('input-form');
  const agentNameEl = document.getElementById('agent-name');

  // Fetch agent info
  fetch('/api/info')
    .then(r => r.json())
    .then(info => {
      if (info.name) {
        agentNameEl.textContent = info.name;
        document.title = info.name + ' â€” Chat';
      }
    })
    .catch(() => {});

  // WebSocket
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  let ws = null;
  let currentAssistantEl = null;
  let currentAssistantText = '';
  let currentThinkingEl = null;
  let currentThinkingText = '';

  function connect() {
    ws = new WebSocket(proto + '//' + location.host + '/ws/chat');
    ws.onopen = () => {};
    ws.onclose = () => { setTimeout(connect, 2000); };
    ws.onerror = () => {};
    ws.onmessage = (e) => {
      const msg = JSON.parse(e.data);
      handleEvent(msg);
    };
  }
  connect();

  function handleEvent(msg) {
    switch (msg.type) {
      case 'token':
        if (!currentAssistantEl) {
          currentAssistantEl = addMessage('assistant', '');
          currentAssistantText = '';
        }
        currentAssistantText += msg.data;
        currentAssistantEl.querySelector('.bubble').innerHTML = renderMarkdown(currentAssistantText);
        scrollToBottom();
        break;

      case 'thinking':
        if (!currentThinkingEl) {
          currentThinkingEl = addCollapsible('thinking', 'Thinking', '');
          currentThinkingText = '';
        }
        currentThinkingText += msg.data;
        currentThinkingEl.querySelector('.thinking-content').textContent = currentThinkingText;
        scrollToBottom();
        break;

      case 'tool_call':
        currentThinkingEl = null;
        currentThinkingText = '';
        addToolCall(msg.data);
        scrollToBottom();
        break;

      case 'tool_result': {
        const toolEls = messagesEl.querySelectorAll('.collapsible.tool-call');
        if (toolEls.length > 0) {
          const last = toolEls[toolEls.length - 1];
          const badge = last.querySelector('.badge-sm');
          if (badge) {
            badge.textContent = 'done';
            badge.classList.remove('running');
          }
          // Stop spinning
          const icon = last.querySelector('.icon');
          if (icon) icon.classList.remove('spinning');
          // Add output
          if (msg.data.output) {
            const body = last.querySelector('.collapsible-body');
            const div = document.createElement('div');
            div.innerHTML = '<div class="section-label">Output</div><pre>' + escapeHtml(msg.data.output) + '</pre>';
            body.appendChild(div);
          }
        }
        scrollToBottom();
        break;
      }

      case 'done':
        currentAssistantEl = null;
        currentAssistantText = '';
        currentThinkingEl = null;
        currentThinkingText = '';
        setSending(false);
        break;

      case 'error':
        addMessage('error', msg.data);
        currentAssistantEl = null;
        currentAssistantText = '';
        currentThinkingEl = null;
        currentThinkingText = '';
        setSending(false);
        scrollToBottom();
        break;
    }
  }

  function addMessage(role, content) {
    emptyState.style.display = 'none';
    const wrapper = document.createElement('div');
    wrapper.className = 'msg ' + role;
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    if (role === 'user') {
      bubble.textContent = content;
    } else {
      bubble.innerHTML = renderMarkdown(content);
    }
    wrapper.appendChild(bubble);
    messagesEl.appendChild(wrapper);
    scrollToBottom();
    return wrapper;
  }

  function addCollapsible(type, label, content) {
    emptyState.style.display = 'none';
    const el = document.createElement('div');
    el.className = 'collapsible ' + type;
    const iconSvg = type === 'thinking'
      ? '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="' + (getComputedStyle(document.documentElement).getPropertyValue('--purple').trim() || '#7c3aed') + '" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>'
      : '';
    el.innerHTML =
      '<div class="collapsible-header" onclick="this.parentElement.classList.toggle(\'open\')">' +
        iconSvg +
        '<span class="label">' + escapeHtml(label) + '</span>' +
        '<svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7"/></svg>' +
      '</div>' +
      '<div class="collapsible-body"><pre class="thinking-content">' + escapeHtml(content) + '</pre></div>';
    messagesEl.appendChild(el);
    return el;
  }

  function addToolCall(data) {
    emptyState.style.display = 'none';
    const el = document.createElement('div');
    el.className = 'collapsible tool-call';
    const isRunning = data.status === 'running';
    el.innerHTML =
      '<div class="collapsible-header" onclick="this.parentElement.classList.toggle(\'open\')">' +
        '<svg class="icon' + (isRunning ? ' spinning' : '') + '" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>' +
        '<span class="label">' + escapeHtml(data.tool || 'tool') + '</span>' +
        '<span class="badge-sm' + (isRunning ? ' running' : '') + '">' + (isRunning ? 'running' : 'done') + '</span>' +
        '<svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7"/></svg>' +
      '</div>' +
      '<div class="collapsible-body">' +
        (data.arguments ? '<div><div class="section-label">Arguments</div><pre>' + escapeHtml(data.arguments) + '</pre></div>' : '') +
      '</div>';
    messagesEl.appendChild(el);
    return el;
  }

  // Basic markdown renderer
  function renderMarkdown(text) {
    if (!text) return '';
    let html = escapeHtml(text);
    // Code blocks
    html = html.replace(/```(\w*)\n([\s\S]*?)```/g, function(_, lang, code) {
      return '<pre><code>' + code + '</code></pre>';
    });
    // Inline code
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    // Bold
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    // Italic
    html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    // Unordered lists
    html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
    // Ordered lists
    html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
    // Links
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
    // Paragraphs (double newline)
    html = html.replace(/\n\n/g, '</p><p>');
    // Single newlines to <br>
    html = html.replace(/\n/g, '<br>');
    return '<p>' + html + '</p>';
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function scrollToBottom() {
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // Input handling
  let sending = false;

  inputEl.addEventListener('input', () => {
    sendBtn.disabled = !inputEl.value.trim() || sending;
    autoResize();
  });

  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (inputEl.value.trim() && !sending) {
        submitMessage();
      }
    }
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    if (inputEl.value.trim() && !sending) {
      submitMessage();
    }
  });

  function submitMessage() {
    const text = inputEl.value.trim();
    if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
    addMessage('user', text);
    ws.send(JSON.stringify({ message: text }));
    inputEl.value = '';
    autoResize();
    setSending(true);
  }

  function setSending(val) {
    sending = val;
    sendBtn.disabled = val || !inputEl.value.trim();
    inputEl.disabled = val;
    if (!val) inputEl.focus();
  }

  function autoResize() {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + 'px';
  }
})();
</script>
</body>
</html>
